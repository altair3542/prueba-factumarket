class SwitchClientesToSequenceDefault < ActiveRecord::Migration[7.1]
  def up
    execute "ALTER SESSION SET CURRENT_SCHEMA=app_user"
    execute <<~SQL
      DECLARE
        v_start NUMBER;
      BEGIN
        SELECT NVL(MAX(ID),0)+1 INTO v_start FROM CLIENTES;
        BEGIN
          EXECUTE IMMEDIATE 'DROP SEQUENCE CLIENTES_SEQ';
        EXCEPTION WHEN OTHERS THEN
          IF SQLCODE != -2289 THEN RAISE; END IF;
        END;
        EXECUTE IMMEDIATE 'CREATE SEQUENCE CLIENTES_SEQ START WITH '||v_start||' INCREMENT BY 1';
      END;
    SQL
    execute "ALTER TABLE CLIENTES MODIFY (ID DEFAULT CLIENTES_SEQ.NEXTVAL NOT NULL)"
    execute "ALTER TABLE CLIENTES MODIFY (CREATED_AT DEFAULT SYSTIMESTAMP)"
    execute "ALTER TABLE CLIENTES MODIFY (UPDATED_AT DEFAULT SYSTIMESTAMP)"
  end

  def down
    execute "ALTER SESSION SET CURRENT_SCHEMA=app_user"
    execute "ALTER TABLE CLIENTES MODIFY (ID DEFAULT NULL)"
    execute <<~SQL
      BEGIN
        EXECUTE IMMEDIATE 'DROP SEQUENCE CLIENTES_SEQ';
      EXCEPTION WHEN OTHERS THEN
        IF SQLCODE != -2289 THEN RAISE; END IF;
      END;
    SQL
  end
end
